name: Backend CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag'
        required: true
        default: 'latest'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.3'

      # ── Step 1: Test ────────────────────────────────────────────────────────
      - name: Test
        run: go test -v ./backend/...

      # ── Step 2: Build binaries ──────────────────────────────────────────────
      - name: Build backend binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -ldflags="-s -w" -o ./dist/backend ./backend/cmd/backend/main.go

      - name: Build gateway binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -ldflags="-s -w" -o ./dist/gateway ./backend/cmd/gateway/main.go

      # ── Step 3: Log in to Docker Hub ────────────────────────────────────────
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ── Step 4: Build and push Docker images ─────────────────
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/cmd/backend/Dockerfile
          push: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' }}
          tags: zukidocker/chat-backend:${{ inputs.tag || 'latest' }}

      - name: Build and push gateway image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/cmd/gateway/Dockerfile
          push: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' }}
          tags: zukidocker/chat-gateway:${{ inputs.tag || 'latest' }}
